<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klipper Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom right, #0f172a, #1e293b, #0f172a);
            min-height: 100vh;
        }
        .webcam-container {
            background: rgba(15, 23, 42, 0.5);
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        .webcam-container:hover::after {
            content: 'üîç Fullscreen';
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
        }
        .webcam-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .error-border {
            animation: pulse-border 2s ease-in-out infinite;
            border-color: #ef4444 !important;
            border-width: 3px !important;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { border-color: #dc2626; box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        .status-blink {
            animation: blink 1s ease-in-out infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        #fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        #fullscreen-modal.active {
            display: flex;
        }
        #fullscreen-modal img {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
        }
        .heating-indicator {
            animation: heating-pulse 1.5s ease-in-out infinite;
        }
        @keyframes heating-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .printer-grid-1 { grid-template-columns: 1fr; }
        .printer-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .printer-grid-3 { grid-template-columns: repeat(2, 1fr); }
        .printer-grid-4 { grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 1536px) {
            .printer-grid-3 { grid-template-columns: repeat(3, 1fr); }
            .printer-grid-4 { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-[2000px] mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6 bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">üñ®Ô∏è Klipper Dashboard</h1>
                <p class="text-slate-400" id="printer-count">0 Drucker verbunden</p>
            </div>
            <div class="flex gap-3 flex-wrap">
                <button onclick="refreshAll()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
                <button onclick="emergencyStopAll()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center gap-2 transition-colors font-bold">
                    ‚ö†Ô∏è GLOBAL NOTAUS
                </button>
                <button onclick="toggleAddForm()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center gap-2 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Drucker
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex gap-2 mb-6 overflow-x-auto">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold whitespace-nowrap">
                üìä Dashboard
            </button>
            <button onclick="switchTab('stats')" id="tab-stats" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold whitespace-nowrap">
                üìà Farm Statistiken
            </button>
        </div>

        <!-- Add Printer Form -->
        <div id="add-form" class="mb-6 bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50 hidden">
            <h3 class="text-white font-semibold mb-4">Neuen Drucker hinzuf√ºgen</h3>
            <div class="flex gap-3">
                <input type="text" id="new-printer-ip" placeholder="z.B. 192.168.1.100:7125" 
                    class="flex-1 px-4 py-2 bg-slate-900 text-white border border-slate-600 rounded-lg focus:outline-none focus:border-blue-500">
                <button onclick="addPrinter()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                    Hinzuf√ºgen
                </button>
            </div>
            <p class="text-slate-400 text-sm mt-2">üí° Tipp: Port 7125 ist Standard f√ºr Moonraker</p>
        </div>

        <!-- Dashboard Tab -->
        <div id="content-dashboard">
            <div id="empty-state" class="text-center py-20 bg-slate-800/30 rounded-2xl border border-slate-700/50">
                <svg class="w-16 h-16 text-slate-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <p class="text-slate-400 text-lg mb-4">Noch keine Drucker hinzugef√ºgt</p>
                <button onclick="toggleAddForm()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg inline-flex items-center gap-2 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Ersten Drucker hinzuf√ºgen
                </button>
            </div>
            <div id="printer-grid" class="grid gap-6"></div>
        </div>

        <!-- Statistics Tab -->
        <div id="content-stats" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Farm Overview -->
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                    <h2 class="text-2xl font-bold text-white mb-4">üè≠ Farm √úbersicht</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <div class="text-slate-400 text-sm mb-1">‚è±Ô∏è Druckstunden</div>
                            <div class="text-white text-2xl font-bold" id="stat-total-hours">0h</div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <div class="text-slate-400 text-sm mb-1">üî• Heizer-Zeit</div>
                            <div class="text-white text-2xl font-bold" id="stat-heater-hours">0h</div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <div class="text-slate-400 text-sm mb-1">‚ö†Ô∏è NOTAUS</div>
                            <div class="text-red-400 text-2xl font-bold" id="stat-estop-count">0</div>
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <div class="text-slate-400 text-sm mb-1">‚ùå Fehler</div>
                            <div class="text-yellow-400 text-2xl font-bold" id="stat-error-count">0</div>
                        </div>
                    </div>
                    <button onclick="resetStats()" class="mt-4 w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                        üîÑ Statistiken zur√ºcksetzen
                    </button>
                </div>

                <!-- Maintenance Settings -->
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                    <h2 class="text-2xl font-bold text-white mb-4">‚öôÔ∏è Wartung</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-slate-400 text-sm mb-2 block">Wartungsintervall (Stunden)</label>
                            <input type="number" id="maintenance-interval" value="100" min="1" 
                                class="w-full px-4 py-2 bg-slate-900 text-white border border-slate-600 rounded-lg focus:outline-none focus:border-blue-500"
                                onchange="saveMaintenanceInterval()">
                        </div>
                        <div class="bg-slate-900/50 rounded-lg p-4">
                            <div class="text-slate-400 text-sm mb-1">‚è≥ N√§chste Wartung in:</div>
                            <div class="text-white text-xl font-bold" id="maintenance-remaining">100h</div>
                        </div>
                        <div class="text-slate-400 text-xs">
                            üí° Bei √úberschreitung erscheint eine Benachrichtigung.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Per-Printer Stats -->
            <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
                <h2 class="text-2xl font-bold text-white mb-4">üìä Drucker-Statistiken</h2>
                <div id="printer-stats-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Modal -->
    <div id="fullscreen-modal" onclick="closeFullscreen()">
        <img id="fullscreen-image" src="" alt="Fullscreen Webcam">
        <button onclick="closeFullscreen()" class="absolute top-4 right-4 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
            ‚úï Schlie√üen
        </button>
    </div>

    <audio id="alert-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGJ0fPTgjMGHm7A7+OZRQ0PVqnm77BdGQY+ltryxnMpBSl+zPLaizsIHGi38+qhTgwKT6Lf8rpjGwU2kdfwzH0tBSV6yPDdkUAKEl60" type="audio/wav">
    </audio>

    <script>
        let printers = [];
        let stats = { totalHours: 0, heaterHours: 0, estopCount: 0, errorCount: 0 };
        let maintenanceInterval = 100;
        let notificationPermission = false;
        let alertedErrors = {};
        let currentTab = 'dashboard';
        let lastStates = {};
        let failedRequests = {};

        window.addEventListener('load', () => {
            requestNotificationPermission();
            loadData();
            setInterval(updateAllData, 3000);
        });

        async function requestNotificationPermission() {
            if ("Notification" in window) {
                const permission = await Notification.requestPermission();
                notificationPermission = permission === "granted";
            }
        }

        function loadData() {
            const savedPrinters = localStorage.getItem('klipper-printers');
            const savedStats = localStorage.getItem('klipper-stats');
            const savedInterval = localStorage.getItem('maintenance-interval');

            if (savedPrinters) printers = JSON.parse(savedPrinters);
            if (savedStats) stats = JSON.parse(savedStats);
            if (savedInterval) {
                maintenanceInterval = parseInt(savedInterval);
                document.getElementById('maintenance-interval').value = maintenanceInterval;
            }

            renderPrinterGrid();
            updateAllData();
            updateStatsDisplay();
        }

        function savePrinters() {
            localStorage.setItem('klipper-printers', JSON.stringify(printers));
        }

        function saveStats() {
            localStorage.setItem('klipper-stats', JSON.stringify(stats));
        }

        function saveMaintenanceInterval() {
            maintenanceInterval = parseInt(document.getElementById('maintenance-interval').value);
            localStorage.setItem('maintenance-interval', maintenanceInterval);
            updateStatsDisplay();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('content-dashboard').classList.toggle('hidden', tab !== 'dashboard');
            document.getElementById('content-stats').classList.toggle('hidden', tab !== 'stats');
            document.getElementById('tab-dashboard').classList.toggle('bg-blue-600', tab === 'dashboard');
            document.getElementById('tab-dashboard').classList.toggle('bg-slate-700', tab !== 'dashboard');
            document.getElementById('tab-stats').classList.toggle('bg-blue-600', tab === 'stats');
            document.getElementById('tab-stats').classList.toggle('bg-slate-700', tab !== 'stats');
            
            if (tab === 'stats') {
                updateStatsDisplay();
                updatePrinterStatsList();
            }
        }

        function toggleAddForm() {
            document.getElementById('add-form').classList.toggle('hidden');
        }

        function addPrinter() {
            const input = document.getElementById('new-printer-ip');
            const ip = input.value.trim();
            if (!ip) return;
            if (printers.some(p => p.ip === ip)) {
                alert('Drucker bereits vorhanden');
                return;
            }
            printers.push({ 
                ip, 
                name: '', 
                lastPrint: '', 
                status: null,
                stats: { hours: 0, heaterHours: 0, estops: 0, errors: 0, lastMaintenance: Date.now() }
            });
            savePrinters();
            input.value = '';
            toggleAddForm();
            renderPrinterGrid();
            fetchPrinterStatus(ip);
        }

        function removePrinter(ip) {
            if (confirm(`Drucker ${ip} entfernen?`)) {
                printers = printers.filter(p => p.ip !== ip);
                savePrinters();
                renderPrinterGrid();
            }
        }

        function updatePrinterName(ip, name) {
            const printer = printers.find(p => p.ip === ip);
            if (printer) {
                printer.name = name;
                savePrinters();
            }
        }

        async function emergencyStopAll() {
            if (confirm('‚ö†Ô∏è GLOBALER NOTAUS f√ºr ALLE Drucker aktivieren?')) {
                let stoppedCount = 0;
                for (const printer of printers) {
                    try {
                        await fetch(`http://${printer.ip}/printer/emergency_stop`, { method: 'POST' });
                        printer.stats.estops++;
                        stats.estopCount++;
                        stoppedCount++;
                    } catch (error) {
                        console.error(`NOTAUS fehlgeschlagen f√ºr ${printer.ip}:`, error);
                    }
                }
                savePrinters();
                saveStats();
                playAlertSound();
                showNotification('‚ö†Ô∏è GLOBALER NOTAUS', `${stoppedCount} von ${printers.length} Drucker gestoppt`);
                setTimeout(() => updateAllData(), 1000);
            }
        }

        async function emergencyStop(ip) {
            if (confirm('‚ö†Ô∏è NOTAUS aktivieren?')) {
                try {
                    await fetch(`http://${ip}/printer/emergency_stop`, { method: 'POST' });
                    const printer = printers.find(p => p.ip === ip);
                    if (printer) {
                        printer.stats.estops++;
                        stats.estopCount++;
                        savePrinters();
                        saveStats();
                    }
                    playAlertSound();
                    setTimeout(() => fetchPrinterStatus(ip), 500);
                } catch (error) {
                    console.error('Fehler beim Notaus:', error);
                }
            }
        }

        async function updateAllData() {
            for (const printer of printers) {
                await fetchPrinterStatus(printer.ip);
            }
        }

        async function fetchPrinterStatus(ip) {
            try {
                const url = `http://${ip}/printer/objects/query?heater_bed&extruder&print_stats&webhooks&toolhead&gcode_move&fan&display_status`;
                const response = await fetch(url);
                const data = await response.json();
                const s = data.result.status;

                failedRequests[ip] = 0;

                const printer = printers.find(p => p.ip === ip);
                if (!printer) return;

                const newPrintState = s.print_stats?.state || 'standby';
                const currentFilename = s.print_stats?.filename || '';
                const lastState = lastStates[ip] || 'standby';

                if (lastState === 'printing' && newPrintState === 'complete') {
                    printer.lastPrint = currentFilename;
                    playAlertSound();
                    showNotification(`‚úÖ Druck fertig: ${printer.name || ip}`, currentFilename);
                }

                if (newPrintState === 'error' && lastState !== 'error') {
                    printer.stats.errors++;
                    stats.errorCount++;
                    playAlertSound();
                    showNotification(`üî¥ Fehler: ${printer.name || ip}`, 'Druckfehler aufgetreten');
                    savePrinters();
                    saveStats();
                }

                if (newPrintState === 'printing') {
                    printer.stats.hours += 3 / 3600;
                    stats.totalHours += 3 / 3600;
                }
                if ((s.extruder?.target || 0) > 50 || (s.heater_bed?.target || 0) > 50) {
                    printer.stats.heaterHours += 3 / 3600;
                    stats.heaterHours += 3 / 3600;
                }

                lastStates[ip] = newPrintState;

                printer.status = {
                    state: s.webhooks?.state || 'unknown',
                    webhooks_state: s.webhooks?.state,
                    bedTemp: s.heater_bed?.temperature || 0,
                    bedTarget: s.heater_bed?.target || 0,
                    extruderTemp: s.extruder?.temperature || 0,
                    extruderTarget: s.extruder?.target || 0,
                    printState: newPrintState,
                    filename: currentFilename,
                    progress: s.display_status?.progress || 0,
                    printDuration: s.print_stats?.print_duration || 0,
                    totalDuration: s.print_stats?.total_duration || 0,
                    speed: s.gcode_move?.speed || 0,
                    speedFactor: s.gcode_move?.speed_factor || 1,
                    extrudeFactor: s.gcode_move?.extrude_factor || 1,
                    fanSpeed: s.fan?.speed || 0,
                    connected: true,
                    hasCriticalError: checkForCriticalErrors(ip, s)
                };

                savePrinters();
                saveStats();
                updatePrinterCard(ip);
            } catch (error) {
                failedRequests[ip] = (failedRequests[ip] || 0) + 1;
                
                if (failedRequests[ip] >= 3) {
                    const printer = printers.find(p => p.ip === ip);
                    if (printer) {
                        printer.status = { connected: false, error: error.message };
                        updatePrinterCard(ip);
                    }
                }
            }
        }

        function checkForCriticalErrors(ip, statusData) {
            const errorKey = `${ip}-error`;
            const criticalErrors = [];

            if (statusData.webhooks?.state === 'error' || statusData.webhooks?.state === 'shutdown') {
                criticalErrors.push('System Error');
            }

            if (criticalErrors.length > 0 && !alertedErrors[errorKey]) {
                alertedErrors[errorKey] = true;
                playAlertSound();
                showNotification(`‚ö†Ô∏è Kritischer Fehler: ${ip}`, criticalErrors.join(', '));
                return true;
            } else if (criticalErrors.length === 0) {
                alertedErrors[errorKey] = false;
            }

            return criticalErrors.length > 0;
        }

        function playAlertSound() {
            const audio = document.getElementById('alert-sound');
            audio.play().catch(e => console.log('Audio play failed:', e));
        }

        function showNotification(title, body) {
            if (notificationPermission) {
                new Notification(title, { body, requireInteraction: true });
            }
        }

        async function sendGcode(ip, gcode) {
            try {
                await fetch(`http://${ip}/printer/gcode/script?script=${encodeURIComponent(gcode)}`, { method: 'POST' });
                setTimeout(() => fetchPrinterStatus(ip), 1500);
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function controlPrint(ip, action) {
            try {
                await fetch(`http://${ip}/printer/print/${action}`, { method: 'POST' });
                setTimeout(() => fetchPrinterStatus(ip), 500);
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        async function setTemperature(ip, heater, temp) {
            const gcode = heater === 'extruder' ? `M104 S${temp}` : `M140 S${temp}`;
            await sendGcode(ip, gcode);
        }

        async function startPrint(ip, filename) {
            if (!filename) return;
            if (confirm(`Druck starten: ${filename}?`)) {
                try {
                    await fetch(`http://${ip}/printer/print/start?filename=${encodeURIComponent(filename)}`, { method: 'POST' });
                    setTimeout(() => fetchPrinterStatus(ip), 1000);
                } catch (error) {
                    alert('Fehler beim Starten');
                }
            }
        }

        function refreshAll() {
            updateAllData();
        }

        function openFullscreen(ip) {
            const modal = document.getElementById('fullscreen-modal');
            const img = document.getElementById('fullscreen-image');
            img.src = `http://${ip}/webcam/?action=stream`;
            modal.classList.add('active');
        }

        function closeFullscreen() {
            document.getElementById('fullscreen-modal').classList.remove('active');
        }

        function formatTime(seconds) {
            if (!seconds || seconds <= 0) return '--:--:--';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h}h ${m}m ${s}s`;
        }

        function formatHours(hours) {
            return `${hours.toFixed(1)}h`;
        }

        function getStatusIcon(state) {
            switch (state) {
                case 'ready': return 'üü¢';
                case 'printing': return 'üîµ';
                case 'paused': return 'üü°';
                case 'error': 
                case 'shutdown': return 'üî¥';
                case 'complete': return '‚úÖ';
                default: return '‚ö™';
            }
        }

        function getStateColor(state) {
            switch (state) {
                case 'ready': return 'text-green-400';
                case 'printing': return 'text-blue-400';
                case 'paused': return 'text-yellow-400';
                case 'error':
                case 'shutdown': return 'text-red-400';
                case 'complete': return 'text-green-400';
                default: return 'text-slate-400';
            }
        }

        function getStateText(state) {
            switch (state) {
                case 'ready': return 'Bereit';
                case 'printing': return 'Druckt';
                case 'paused': return 'Pausiert';
                case 'complete': return 'Fertig';
                case 'error': return 'Fehler';
                case 'shutdown': return 'Shutdown';
                default: return 'Unbekannt';
            }
        }

        function renderPrinterGrid() {
            document.getElementById('printer-count').textContent = `${printers.length} Drucker verbunden`;
            
            const emptyState = document.getElementById('empty-state');
            const grid = document.getElementById('printer-grid');
            
            if (printers.length === 0) {
                emptyState.classList.remove('hidden');
                grid.innerHTML = '';
                return;
            }
            
            emptyState.classList.add('hidden');
            grid.className = `grid gap-6 printer-grid-${Math.min(printers.length, 4)}`;
            
            grid.innerHTML = printers.map(printer => {
                const safeId = printer.ip.replace(/[.:]/g, '-');
                const webcamUrl = `http://${printer.ip}/webcam/?action=stream`;
                
                return `
                <div id="printer-${safeId}" 
                    class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 border border-slate-700/50 hover:border-slate-600/50 transition-all">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <input type="text" value="${printer.name || ''}" 
                                placeholder="Druckername..." 
                                onblur="updatePrinterName('${printer.ip}', this.value)"
                                class="text-white font-semibold text-lg mb-1 bg-transparent border-b border-transparent hover:border-slate-600 focus:border-blue-500 focus:outline-none w-full transition-colors"
                                onclick="this.select()">
                            <div class="text-slate-500 text-xs mb-1">${printer.ip}</div>
                            <div class="printer-status-indicator"></div>
                        </div>
                        <button onclick="removePrinter('${printer.ip}')" class="p-2 text-slate-400 hover:text-red-400 hover:bg-red-900/20 rounded-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="webcam-container mb-3" onclick="openFullscreen('${printer.ip}')">
                        <img id="webcam-${safeId}" src="${webcamUrl}" alt="Webcam" 
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; flex-direction: column; align-items: center; color: #64748b;">
                            <p class="text-sm">üì∑ Webcam nicht verf√ºgbar</p>
                        </div>
                    </div>
                    
                    <div class="printer-file-info"></div>
                    <div class="printer-last-print"></div>
                    <div class="printer-temps"></div>
                    <div class="printer-speed-flow"></div>
                    <div class="printer-controls"></div>
                    
                    <button onclick="emergencyStop('${printer.ip}')" 
                        class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg border-2 border-red-500 mt-2">
                        ‚ö†Ô∏è NOTAUS
                    </button>
                </div>
            `;
            }).join('');

            printers.forEach(p => updatePrinterCard(p.ip));
        }

        function updatePrinterCard(ip) {
            const printer = printers.find(p => p.ip === ip);
            if (!printer) return;

            const cardId = `printer-${ip.replace(/[.:]/g, '-')}`;
            const card = document.getElementById(cardId);
            if (!card) return;

            const status = printer.status;
            if (!status) return;

            if (status.hasCriticalError) {
                card.classList.add('error-border');
            } else {
                card.classList.remove('error-border');
            }

            const statusIndicator = card.querySelector('.printer-status-indicator');
            const statusBlinkClass = status.hasCriticalError ? 'status-blink' : '';
            statusIndicator.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-2xl ${statusBlinkClass}">${getStatusIcon(status.printState)}</span>
                    <span class="text-sm font-medium ${getStateColor(status.printState)} ${statusBlinkClass}">
                        ${getStateText(status.printState)}
                    </span>
                </div>
            `;

            if (!status.connected) {
                card.querySelector('.printer-file-info').innerHTML = '<div class="bg-red-900/20 rounded-lg p-3 mb-3 text-red-400 text-sm">‚ùå Nicht erreichbar</div>';
                return;
            }

            const fileInfo = card.querySelector('.printer-file-info');
            const remainingTime = status.totalDuration && status.progress > 0 
                ? status.totalDuration * (1 - status.progress) 
                : 0;

            if (status.filename) {
                fileInfo.innerHTML = `
                    <div class="bg-slate-900/50 rounded-lg p-3 mb-3">
                        <p class="text-slate-400 text-xs mb-1">üìÑ Aktuelle Datei:</p>
                        <p class="text-white text-sm font-medium truncate mb-2">${status.filename}</p>
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span>‚è± ${(status.progress * 100).toFixed(1)}%</span>
                            <span>‚è≥ ${formatTime(remainingTime)}</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${(status.progress * 100).toFixed(1)}%"></div>
                        </div>
                    </div>
                `;
            } else {
                fileInfo.innerHTML = '';
            }

            const lastPrint = card.querySelector('.printer-last-print');
            if (printer.lastPrint && !status.filename) {
                lastPrint.innerHTML = `
                    <div class="bg-slate-900/50 rounded-lg p-3 mb-3 border border-slate-700">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <p class="text-slate-400 text-xs mb-1">üïê Letzter Druck:</p>
                                <p class="text-white text-sm font-medium truncate">${printer.lastPrint}</p>
                            </div>
                            <button onclick="startPrint('${ip}', '${printer.lastPrint}')" 
                                class="ml-2 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs whitespace-nowrap">
                                üîÅ Erneut
                            </button>
                        </div>
                    </div>
                `;
            } else {
                lastPrint.innerHTML = '';
            }

            const isHeating = (status.extruderTarget > status.extruderTemp + 5) || 
                              (status.bedTarget > status.bedTemp + 3);
            const heatingClass = isHeating ? 'heating-indicator' : '';
            const safeId = ip.replace(/[.:]/g, '-');

            const temps = card.querySelector('.printer-temps');
            temps.innerHTML = `
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-slate-900/50 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-orange-400 ${heatingClass}">üî•</span>
                            <span class="text-slate-400 text-xs">Nozzle</span>
                        </div>
                        <div class="text-white font-semibold text-lg mb-1">
                            ${status.extruderTemp.toFixed(1)}¬∞
                            <span class="text-slate-500 text-sm">/ ${status.extruderTarget.toFixed(0)}¬∞</span>
                        </div>
                        <div class="flex gap-1">
                            <input type="number" id="ext-${safeId}" value="${status.extruderTarget.toFixed(0)}" 
                                class="w-16 px-2 py-1 bg-slate-800 text-white text-xs border border-slate-600 rounded" min="0" max="300">
                            <button onclick="setTemperature('${ip}', 'extruder', document.getElementById('ext-${safeId}').value)" 
                                class="flex-1 px-2 py-1 bg-orange-600 hover:bg-orange-700 text-white text-xs rounded">Set</button>
                        </div>
                    </div>

                    <div class="bg-slate-900/50 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-blue-400 ${heatingClass}">üî•</span>
                            <span class="text-slate-400 text-xs">Bed</span>
                        </div>
                        <div class="text-white font-semibold text-lg mb-1">
                            ${status.bedTemp.toFixed(1)}¬∞
                            <span class="text-slate-500 text-sm">/ ${status.bedTarget.toFixed(0)}¬∞</span>
                        </div>
                        <div class="flex gap-1">
                            <input type="number" id="bed-${safeId}" value="${status.bedTarget.toFixed(0)}" 
                                class="w-16 px-2 py-1 bg-slate-800 text-white text-xs border border-slate-600 rounded" min="0" max="120">
                            <button onclick="setTemperature('${ip}', 'bed', document.getElementById('bed-${safeId}').value)" 
                                class="flex-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded">Set</button>
                        </div>
                    </div>
                </div>
            `;

            const speedFlow = card.querySelector('.printer-speed-flow');
            speedFlow.innerHTML = `
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-slate-900/50 rounded-lg p-3">
                        <div class="text-slate-400 text-xs mb-1">üéØ Speed</div>
                        <div class="text-white font-semibold">${(status.speedFactor * 100).toFixed(0)}%</div>
                        <div class="text-slate-500 text-xs">${(status.speed / 60).toFixed(0)} mm/s</div>
                    </div>
                    <div class="bg-slate-900/50 rounded-lg p-3">
                        <div class="text-slate-400 text-xs mb-1">üíß Flow</div>
                        <div class="text-white font-semibold">${(status.extrudeFactor * 100).toFixed(0)}%</div>
                        <div class="text-slate-500 text-xs">Fan: ${(status.fanSpeed * 100).toFixed(0)}%</div>
                    </div>
                </div>
            `;

            const controls = card.querySelector('.printer-controls');
            let controlButtons = '';
            if (status.printState === 'printing') {
                controlButtons = `
                    <button onclick="controlPrint('${ip}', 'pause')" class="flex-1 px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm">
                        ‚è∏ Pause
                    </button>
                    <button onclick="controlPrint('${ip}', 'cancel')" class="flex-1 px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm">
                        ‚èπ Stop
                    </button>
                `;
            } else if (status.printState === 'paused') {
                controlButtons = `
                    <button onclick="controlPrint('${ip}', 'resume')" class="flex-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
                        ‚ñ∂ Fortsetzen
                    </button>
                    <button onclick="controlPrint('${ip}', 'cancel')" class="flex-1 px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm">
                        ‚èπ Stop
                    </button>
                `;
            } else {
                controlButtons = `
                    <button onclick="sendGcode('${ip}', 'G28')" class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
                        üè† Home All
                    </button>
                `;
            }
            controls.innerHTML = `<div class="flex gap-2 mb-2">${controlButtons}</div>`;
        }

        function updateStatsDisplay() {
            document.getElementById('stat-total-hours').textContent = formatHours(stats.totalHours);
            document.getElementById('stat-heater-hours').textContent = formatHours(stats.heaterHours);
            document.getElementById('stat-estop-count').textContent = stats.estopCount;
            document.getElementById('stat-error-count').textContent = stats.errorCount;
            
            const remaining = maintenanceInterval - stats.totalHours;
            const remainingText = remaining > 0 ? formatHours(remaining) : '‚ö†Ô∏è Wartung f√§llig!';
            document.getElementById('maintenance-remaining').textContent = remainingText;
            
            if (remaining <= 0 && !alertedErrors['maintenance-due']) {
                alertedErrors['maintenance-due'] = true;
                showNotification('‚ö†Ô∏è Wartung f√§llig', `Wartungsintervall von ${maintenanceInterval}h √ºberschritten`);
            } else if (remaining > 0) {
                alertedErrors['maintenance-due'] = false;
            }
        }

        function updatePrinterStatsList() {
            const list = document.getElementById('printer-stats-list');
            list.innerHTML = printers.map(p => `
                <div class="bg-slate-900/50 rounded-lg p-4">
                    <h3 class="text-white font-semibold mb-2">${p.name || p.ip}</h3>
                    <div class="grid grid-cols-4 gap-3">
                        <div>
                            <div class="text-slate-400 text-xs">Druckstunden</div>
                            <div class="text-white font-bold">${formatHours(p.stats.hours)}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 text-xs">Heizer</div>
                            <div class="text-white font-bold">${formatHours(p.stats.heaterHours)}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 text-xs">NOTAUS</div>
                            <div class="text-red-400 font-bold">${p.stats.estops}</div>
                        </div>
                        <div>
                            <div class="text-slate-400 text-xs">Fehler</div>
                            <div class="text-yellow-400 font-bold">${p.stats.errors}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function resetStats() {
            if (confirm('Alle Statistiken zur√ºcksetzen?')) {
                stats = { totalHours: 0, heaterHours: 0, estopCount: 0, errorCount: 0 };
                printers.forEach(p => {
                    p.stats = { hours: 0, heaterHours: 0, estops: 0, errors: 0, lastMaintenance: Date.now() };
                });
                savePrinters();
                saveStats();
                updateStatsDisplay();
                updatePrinterStatsList();
            }
        }

        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && document.activeElement.id === 'new-printer-ip') {
                addPrinter();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFullscreen();
            }
        });
    </script>
</body>
</html>
